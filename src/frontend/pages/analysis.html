<!-- Analysis Page -->
<div id="analysis-page" class="page">
    <div class="page-header">
        <h1>Analyse de Programme de Maintenance</h1>
        <p>Analysez les programmes hebdomadaires avec donn√©es concat√©n√©es d'engins</p>
    </div>

    <!-- Add this right after the page-header section -->
    <div class="help-section">
        <div class="card">
            <div class="card-header">
                <h4>üìä Comment interpr√©ter les r√©sultats</h4>
                <button class="info-toggle" data-target="interpretation-guide">‚ÑπÔ∏è</button>
            </div>
            <div class="card-info" id="interpretation-guide">
                <h5>Principes de calcul importants :</h5>
                <ol>
                    <li><strong>Jours d'immobilisation</strong> : Un jour calendaire o√π un engin est en maintenance.</li>
                    <li><strong>Comptage unique</strong> : Si plusieurs op√©rations sont effectu√©es en parall√®le sur un m√™me engin le m√™me jour, ce jour n'est compt√© qu'une seule fois.</li>
                    <li><strong>RDV invalides</strong> : Les rendez-vous avec des dates manquantes ou incorrectes sont marqu√©s comme invalides et exclus des calculs de dur√©e.</li>
                    <li><strong>Jours avec RDV</strong> : Nombre total de jours calendaires uniques o√π le site a au moins un engin en maintenance.</li>
                    <li><strong>Heures d'immobilisation</strong> : Calcul√©es comme Jours d'immobilisation √ó 24h.</li>
                </ol>
                
                <h5>Exemple :</h5>
                <p>Si un engin BB75000 a trois op√©rations distinctes pr√©vues le 20/05/2025, l'analyse :</p>
                <ul>
                    <li>Compte 3 RDV distincts</li>
                    <li>Mais compte seulement 1 jour d'immobilisation</li>
                    <li>Ce qui donne 24h d'immobilisation (1 jour √ó 24h)</li>
                </ul>
                
                <p>Cela refl√®te le fait que l'engin est indisponible une seule journ√©e, m√™me si plusieurs op√©rations sont programm√©es en parall√®le.</p>
            </div>
        </div>
    </div>

    <div class="help-section">
        <div class="card">
            <div class="card-header">‚ÑπÔ∏è √Ä propos de l'analyse PHP</div>
            <div class="card-body">
                <div class="help-content">
                    <h4>Analyses sp√©cifiques des fichiers PHP :</h4>
                    <ul>
                        <li><strong>Planning hebdomadaire :</strong> Analyse des r√©sultats par semaine
                        </li>
                        <li><strong>Analyse des engins :</strong> Analyse des donn√©es sp√©cifiques √† chaque s√©rie d'engins
                        </li>
                        <li><strong>Sommaire des donn√©es :</strong> Fusion des donn√©es pour identification unique
                        </li>
                        <li><strong>D√©tection de conflits :</strong> Identification des Immobilisations exc√©dentaires
                        </li>
                    </ul>

                    <h4>Structure attendue :</h4>
                    <p>- En-t√™tes ligne 3</p>
                    <p>- Colonne des n¬∞ de semaine : N</p>
                    <p><strong>Attention :</strong> La structure attendue doit √™tre respect√©e pour garantir une analyse correcte.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Section -->
    <div class="upload-container">
        <div class="upload-section">
            <div class="card">
                <div class="card-header">üìÅ Fichier √† analyser</div>
                <div class="card-body">
                    <div class="file-upload-area" id="analysis-file-area">
                        <div class="upload-prompt">
                            <p><strong>Glissez-d√©posez votre fichier Excel ici</strong></p>
                            <p>ou cliquez pour s√©lectionner</p>
                            <input type="file" id="analysis-file-input" accept=".xlsx,.xls" style="display: none;">
                        </div>
                        <div class="upload-hint">
                            Fichier avec en-t√™tes ligne 3<br>
                            Formats : .xlsx, .xls
                        </div>
                    </div>

                    <!-- File Information -->
                    <div id="analysis-file-info" class="file-info" style="display: none;">
                        <h4>Fichier s√©lectionn√©</h4>
                        <div id="analysis-file-details"></div>
                    </div>

                    <!-- Sheet Selection -->
                    <div id="analysis-sheet-selection" class="config-section" style="display: none;">
                        <label for="analysis-sheet-select">Feuille √† analyser :</label>
                        <select id="analysis-sheet-select">
                            <option value="">S√©lectionner une feuille...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Configuration -->
        <div class="upload-section">
            <div class="card">
                <div class="card-header">‚öôÔ∏è Options d'analyse</div>
                <div class="card-body">
                    <!-- Analysis Type -->
                    <div class="config-section">
                        <label>Types d'analyses :</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="weekly-planning" checked>
                                <label for="weekly-planning">Planning hebdomadaire</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="equipment-analysis" checked>
                                <label for="equipment-analysis">Analyse des s√©ries</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="concatenation-analysis" checked>
                                <label for="concatenation-analysis">Donn√©es concat√©n√©es RDV</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="conflict-detection" checked>
                                <label for="conflict-detection">D√©tection de conflits</label>
                            </div>
                        </div>
                    </div>

                    <!-- Week Selection -->
                    <div class="config-section">
                        <div class="form-group">
                            <label for="analysis-week">Semaine √† analyser :</label>
                            <select id="analysis-week">
                                <option value="all" selected>Toutes les semaines</option>
                            </select>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="config-actions">
                        <button class="btn primary-btn" id="start-analysis-btn" disabled>
                            üîç Analyser
                        </button>
                        <button class="btn secondary-btn" id="reset-analysis-btn">
                            üîÑ R√©initialiser
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Progress -->
    <div id="analysis-progress" class="progress-section" style="display: none;">
        <div class="card">
            <div class="card-header">Progression de l'analyse</div>
            <div class="card-body">
                <div class="progress">
                    <div class="progress-bar" id="analysis-progress-bar" style="width: 0%"></div>
                </div>
                <p id="analysis-progress-text">Initialisation...</p>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    <div id="analysis-results" class="results-section" style="display: none;">

        <!-- Summary Metrics -->
        <div class="php-metrics">
            <div class="php-metric-card" data-tooltip="Nombre total de rendez-vous dans l'analyse">
                <div class="php-metric-value" id="total-rdv">0</div>
                <div class="php-metric-label">Total RDV</div>
                <div class="metric-info">‚ÑπÔ∏è</div>
            </div>
            <div class="php-metric-card" data-tooltip="Nombre de clients uniques identifi√©s">
                <div class="php-metric-value" id="total-clients">0</div>
                <div class="php-metric-label">Total Clients</div>
                <div class="metric-info">‚ÑπÔ∏è</div>
            </div>
            <div class="php-metric-card" data-tooltip="Nombre de s√©ries d'engins diff√©rentes">
                <div class="php-metric-value" id="total-equipment">0</div>
                <div class="php-metric-label">Total de s√©ries</div>
                <div class="metric-info">‚ÑπÔ∏è</div>
            </div>
            <div class="php-metric-card" data-tooltip="Somme des heures d'immobilisation de tous les engins - Plusieurs op√©rations peuvent √™tre effectu√©es en parall√®le sur un m√™me engin">
                <div class="php-metric-value" id="weekly-hours">0h</div>
                <div class="php-metric-label">Total Heures</div>
                <div class="metric-info">‚ÑπÔ∏è</div>
            </div>
            <div class="php-metric-card" data-tooltip="Nombre de jours calendaires o√π le site a au moins un engin en maintenance">
                <div class="php-metric-value" id="occupancy-rate">0</div>
                <div class="php-metric-label">Jours avec RDV</div>
                <div class="metric-info">‚ÑπÔ∏è</div>
            </div>
            <div class="php-metric-card" data-tooltip="Nombre d'anomalies d√©tect√©es (dates manquantes, invers√©es ou incoh√©rentes)">
                <div class="php-metric-value" id="conflict-count">0</div>
                <div class="php-metric-label">Conflits</div>
                <div class="metric-info">‚ÑπÔ∏è</div>
            </div>
        </div>

        <!-- Weekly Planning Analysis -->
        <div id="weekly-section" class="analysis-section">
            <div class="card">
                <div class="card-header">
                    <h4>üìÖ Planning hebdomadaire</h4>
                    <button class="info-toggle" data-target="weekly-info">‚ÑπÔ∏è</button>
                </div>
                <div class="card-info" id="weekly-info">
                    <strong>Comment lire ce tableau :</strong>
                    <ul>
                        <li><strong>RDV :</strong> Nombre de rendez-vous programm√©s par semaine</li>
                        <li><strong>Dur√©e moy. RDV :</strong> Dur√©e moyenne d'un RDV en heures</li>
                        <li><strong>Immobilisation :</strong> Jours calendaires o√π les engins sont en maintenance. <em>Si plusieurs op√©rations ont lieu le m√™me jour sur un m√™me engin, ce jour n'est compt√© qu'une seule fois.</em></li>
                    </ul>
                </div>
                <div class="card-body">
                    <div id="weekly-content">
                        <p class="no-data">Aucune donn√©e de planning disponible</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Analysis -->
        <div id="equipment-section" class="analysis-section">
            <div class="card">
                <div class="card-header">
                    <h4>üöÇ Analyse des s√©ries</h4>
                    <button class="info-toggle" data-target="equipment-info">‚ÑπÔ∏è</button>
                </div>
                <div class="card-info" id="equipment-info">
                    <strong>Comment interpr√©ter les r√©sultats :</strong>
                    <ul>
                        <li><strong>RDV Total :</strong> Nombre total de rendez-vous programm√©s pour cette s√©rie</li>
                        <li><strong>RDV Valides/Invalides :</strong> Les RDV invalides ont des dates manquantes ou incorrectes et sont exclus des calculs de dur√©e</li>
                        <li><strong>Jours d'immobilisation :</strong> Nombre de jours calendaires distincts o√π la s√©rie est immobilis√©e</li>
                        <li><strong>Heures d'immobilisation :</strong> Jours d'immobilisation √ó 24h</li>
                        <li><strong>Dur√©e moyenne :</strong> Heures totales √∑ Nombre de RDV valides</li>
                    </ul>
                    <p><em>Note : Si plusieurs op√©rations sont effectu√©es en parall√®le sur un m√™me engin le m√™me jour, ce jour n'est compt√© qu'une seule fois dans le calcul des jours d'immobilisation.</em></p>
                </div>
                <div class="card-body">
                    <div id="equipment-content">
                        <p class="no-data">Aucune donn√©e d'engins disponible</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Concatenated Data Analysis -->
        <div id="concatenation-section" class="analysis-section">
            <div class="card">
                <div class="card-header">
                    <h4>üîó Donn√©es concat√©n√©es RDV</h4>
                    <div class="card-subtitle">Site_Engin_DateD√©but_DateFin_Client</div>
                    <button class="info-toggle" data-target="concat-info">‚ÑπÔ∏è</button>
                </div>
                    <div class="card-info" id="concat-info">
                        <strong>√Ä propos des donn√©es concat√©n√©es :</strong>
                        <ul>
                            <li>Chaque ligne repr√©sente <strong>un engin unique</strong> avec ses op√©rations group√©es</li>
                            <li>Les op√©rations simultan√©es ou cons√©cutives sur le m√™me engin sont regroup√©es</li>
                            <li>Les dates correspondent √† la p√©riode totale d'immobilisation de l'engin</li>
                            <li>Le num√©ro d'engin affich√© est le <strong>num√©ro de mat√©riel roulant</strong> (colonne C)</li>
                            <li>Les jours sont calcul√©s de la premi√®re date de d√©but √† la derni√®re date de fin</li>
                            <li>Les heures sont calcul√©es comme Jours √ó 24h</li>
                        </ul>
                        <p><strong>Exemple :</strong> Si un engin a 3 op√©rations entre le 20/05 et le 22/05, cela appara√Ætra comme 1 ligne avec 3 jours d'immobilisation.</p>
                    </div>
                <div class="card-body">
                    <div class="filters-section">
                        <div class="filters-container">
                            <div class="filter-group">
                                <label for="concat-filter-client">Client :</label>
                                <select id="concat-filter-client" class="form-control">
                                    <option value="">Tous les clients</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="concat-filter-engin">S√©rie :</label>
                                <select id="concat-filter-engin" class="form-control">
                                    <option value="">Toutes les s√©ries</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="concat-filter-date">Date :</label>
                                <div class="date-input-group">
                                    <input type="date" id="concat-filter-date" class="form-control">
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>&nbsp;</label>
                                <div class="filter-buttons">
                                    <button id="apply-concat-filter" class="btn primary-btn btn-sm">Appliquer</button>
                                    <button id="clear-concat-filter" class="btn secondary-btn btn-sm">Effacer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="concatenation-content">
                        <p class="no-data">Aucune donn√©e concat√©n√©e disponible</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conflict Detection -->
        <div id="conflicts-section" class="analysis-section">
            <div class="card">
                <div class="card-header">
                    <h4>‚ö†Ô∏è Conflits d√©tect√©s</h4>
                    <button class="info-toggle" data-target="conflicts-info">‚ÑπÔ∏è</button>
                </div>
                <div class="card-info" id="conflicts-info">
                    <strong>Types de conflits d√©tect√©s :</strong>
                    <ul>
                        <li><strong>Date d√©but manquante :</strong> L'engin n'est peut-√™tre pas encore sur site</li>
                        <li><strong>Date fin manquante :</strong> L'entretien n'est peut-√™tre pas encore d√©fini</li>
                        <li><strong>Inversion de dates :</strong> La date de fin est ant√©rieure √† la date de d√©but</li>
                        <li><strong>Immobilisation excessive :</strong> P√©riode d'immobilisation anormalement longue (>1000 jours)</li>
                    </ul>
                    <p><em>Les conflits de m√™me type sur un m√™me engin sont group√©s pour plus de clart√©.</em></p>
                </div>
                <div class="card-body">
                    <div id="conflicts-content">
                        <p class="no-data">Aucun conflit d√©tect√©</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <div class="card">
                <div class="card-header">üíæ Export de l'analyse</div>
                <div class="card-body">
                    <div class="export-controls">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="export-summary" checked>
                                <label for="export-summary">R√©sum√©</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="export-concatenated" checked>
                                <label for="export-concatenated">Donn√©es concat√©n√©es</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="export-conflicts" checked>
                                <label for="export-conflicts">Liste des conflits</label>
                            </div>
                        </div>

                        <div class="radio-group">
                            <label><input type="radio" name="analysis-export-format" value="excel" checked> Excel (.xlsx)</label>
                            <label><input type="radio" name="analysis-export-format" value="csv"> CSV</label>
                            <label><input type="radio" name="analysis-export-format" value="pdf"> PDF</label>
                        </div>

                        <div class="filename-input">
                            <label for="analysis-export-filename">Nom du fichier :</label>
                            <input type="text" id="analysis-export-filename" placeholder="analyse_maintenance">
                        </div>

                        <div class="export-actions">
                            <button class="btn primary-btn" id="export-analysis-btn" disabled>
                                üíæ Exporter l'Analyse
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>