<div class="page-header">
    <h1>Mentions Légales</h1>
    <p>Informations légales et conditions d'utilisation</p>
</div>

<div class="legal-tabs">
    <button class="legal-tab active" data-doc="terms_of_use.md">Conditions d'utilisation</button>
    <button class="legal-tab" data-doc="privacy_policy.md">Politique de confidentialité</button>
    <button class="legal-tab" data-doc="licence.md">Licence</button>
</div>

<div id="legal-content" class="doc-container">
    <div class="loading-docs">
        <div class="loading-spinner"></div>
        <p>Chargement des mentions légales...</p>
    </div>
</div>

<script>
    (function() {
        const legalContent = document.getElementById('legal-content');
        let currentDoc = 'terms_of_use.md';
        
        // Function to get the backend URL (set by Electron or default for web)
        function getBackendUrl() {
            return window.BACKEND_URL || 'http://localhost:5000';
        }
        
        // Enhanced markdown to HTML conversion (same as help page)
        function enhancedMarkdownToHtml(markdown) {
            // Process the table of contents first
            let toc = '<div class="toc-container"><h2>Table des Matières</h2><ul class="toc-list">';
            let tocItems = [];
            
            // Extract headings for TOC
            const headingRegex = /^(#{1,3})\s+(.+)$/gm;
            let match;
            while ((match = headingRegex.exec(markdown)) !== null) {
                const level = match[1].length;
                const text = match[2].trim();
                const id = text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                
                tocItems.push({
                    level: level,
                    text: text,
                    id: id
                });
            }
            
            // Build TOC HTML (only if there are multiple headings)
            if (tocItems.length > 1) {
                tocItems.forEach(item => {
                    toc += `<li class="toc-item toc-level-${item.level}"><a href="#${item.id}" class="toc-link">${item.text}</a></li>`;
                });
                toc += '</ul></div>';
            } else {
                toc = ''; // No TOC for single section documents
            }
            
            // Replace Markdown syntax with HTML
            let html = markdown
                // Headers with IDs
                .replace(/^# (.+)$/gm, (match, title) => {
                    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h1 id="${id}" class="legal-heading legal-h1">${title}</h1>`;
                })
                .replace(/^## (.+)$/gm, (match, title) => {
                    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h2 id="${id}" class="legal-heading legal-h2">${title}</h2>`;
                })
                .replace(/^### (.+)$/gm, (match, title) => {
                    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h3 id="${id}" class="legal-heading legal-h3">${title}</h3>`;
                })
                .replace(/^#### (.+)$/gm, (match, title) => {
                    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h4 id="${id}" class="legal-heading legal-h4">${title}</h4>`;
                })
                
                // Lists
                .replace(/^\s*(?:[0-9]+\.|\-|\*)\s+(.+)$/gm, function(match, item) {
                    const isNumbered = match.trim().match(/^[0-9]+\./);
                    return `<li class="legal-list-item">${item}</li>`;
                })
                
                // Bold and Italic
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                
                // Links
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                    if (url.startsWith('#')) {
                        return `<a href="${url}" class="legal-link toc-link">${text}</a>`;
                    } else {
                        return `<a href="${url}" class="legal-link" target="_blank" rel="noopener noreferrer">${text}</a>`;
                    }
                })
                
                // Code blocks (for legal references)
                .replace(/`([^`]+)`/g, '<code class="legal-code">$1</code>')
                
                // Code blocks (multi-line)
                .replace(/```([^```]+)```/g, '<pre class="legal-code-block"><code>$1</code></pre>');

            // Convert newlines to paragraphs
            const paragraphs = html.split(/\n\n+/);
            html = paragraphs.map(p => {
                p = p.trim();
                
                // Skip if already wrapped in HTML tag
                if (p.startsWith('<h') || p.startsWith('<li') || p.startsWith('<pre') || p === '') return p;
                
                // Wrap content in paragraph tags if it contains text
                if (p.match(/\S/)) return `<p class="legal-paragraph">${p}</p>`;
                
                return p;
            }).join('');
            
            // Fix lists - wrap consecutive li elements
            html = html.replace(/(<li class="legal-list-item">.*?<\/li>)\s*(<li class="legal-list-item">)/gs, '$1\n<li class="legal-list-item">');
            
            // Wrap series of li in ul or ol
            const listItemRegex = /<li class="legal-list-item">.*?<\/li>/gs;
            let lastIndex = 0;
            let result = '';
            let listItems;
            
            while ((listItems = listItemRegex.exec(html)) !== null) {
                result += html.substring(lastIndex, listItems.index);
                
                const isNumbered = html.substring(Math.max(0, listItems.index - 20), listItems.index).match(/[0-9]+\./);
                const listTag = isNumbered ? 'ol' : 'ul';
                
                let listContent = listItems[0];
                let nextItemMatch;
                let nextIndex = listItems.index + listItems[0].length;
                
                while ((nextItemMatch = /<li class="legal-list-item">.*?<\/li>/s.exec(html.substring(nextIndex))) !== null && 
                      html.substring(nextIndex, nextIndex + nextItemMatch.index).trim() === '') {
                    listContent += nextItemMatch[0];
                    nextIndex += nextItemMatch.index + nextItemMatch[0].length;
                }
                
                result += `<${listTag} class="legal-list">${listContent}</${listTag}>`;
                lastIndex = nextIndex;
                listItemRegex.lastIndex = nextIndex;
            }
            
            result += html.substring(lastIndex);
            
            return toc + '<div class="legal-content">' + result + '</div>';
        }
        
        // Function to wait for backend to be ready (with timeout)
        async function waitForBackend() {
            const backendUrl = getBackendUrl();
            let retries = 0;
            const maxRetries = 20;
            
            while (retries < maxRetries) {
                try {
                    const response = await fetch(`${backendUrl}/health`, { 
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        console.log('Backend is ready for legal page');
                        return true;
                    }
                } catch (error) {
                    console.log(`Waiting for backend for legal page... (attempt ${retries + 1})`);
                }
                
                retries++;
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            throw new Error('Backend not available after multiple attempts');
        }
        
        // Function to debug available docs
        async function debugAvailableLegalDocs() {
            try {
                const backendUrl = getBackendUrl();
                const response = await fetch(`${backendUrl}/api/docs/list`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Available legal documentation files:', data.legal_files);
                    return data;
                } else {
                    console.error('Failed to get legal docs list:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error getting legal docs list:', error);
                return null;
            }
        }
        
        // Load and display document
        async function loadDocument(filename) {
            legalContent.innerHTML = `
                <div class="loading-docs">
                    <div class="loading-spinner"></div>
                    <p>Chargement du document...</p>
                </div>
            `;
            
            try {
                // Wait for backend to be ready
                await waitForBackend();
                
                const backendUrl = getBackendUrl();
                console.log('Loading legal document from:', `${backendUrl}/docs/legal/${filename}`);
                
                // Add a small delay to ensure backend is fully ready
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const response = await fetch(`${backendUrl}/docs/legal/${filename}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain',
                        'Content-Type': 'text/plain; charset=utf-8'
                    }
                });
                
                if (!response.ok) {
                    // Debug available docs if main request fails
                    await debugAvailableLegalDocs();
                    throw new Error(`Failed to load ${filename}: ${response.status} ${response.statusText}`);
                }
                
                const markdown = await response.text();
                
                if (!markdown || markdown.trim().length === 0) {
                    throw new Error('Loaded markdown content is empty');
                }
                
                console.log('Successfully loaded legal markdown content, length:', markdown.length);
                
                // Format the markdown into beautiful HTML
                const formattedContent = enhancedMarkdownToHtml(markdown);
                
                legalContent.innerHTML = `
                    <div class="legal-card">
                        <div class="card-body legal-body">
                            ${formattedContent}
                        </div>
                    </div>
                `;
                
                // Remove target="_blank" from internal links
                legalContent.querySelectorAll('a.legal-link').forEach(a => {
                    if (a.getAttribute('href')?.startsWith('#')) {
                        a.removeAttribute('target');
                    }
                });
                
                // Add smooth scrolling for TOC links
                document.querySelectorAll('.toc-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = e.target.getAttribute('href').substring(1);
                        const targetElement = document.getElementById(targetId);
                        
                        if (targetElement) {
                            targetElement.scrollIntoView({ 
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    });
                });
                
                console.log('Legal content loaded successfully');
                
            } catch (error) {
                console.error('Error loading legal document:', error);
                
                legalContent.innerHTML = `
                    <div class="error-box">
                        <h3>Erreur de chargement</h3>
                        <p>Impossible de charger le document "${filename}": ${error.message}</p>
                        <p><strong>Backend URL:</strong> ${getBackendUrl()}</p>
                        <button onclick="loadLegalDocument('${filename}')" class="btn btn-primary" style="margin: 0.5rem;">Réessayer</button>
                        <button onclick="window.debugLegalDocs()" class="btn btn-secondary" style="margin: 0.5rem;">Debug Info</button>
                    </div>
                `;
            }
        }
        
        // Global functions for retry and debug
        window.loadLegalDocument = loadDocument;
        window.debugLegalDocs = async function() {
            const info = await debugAvailableLegalDocs();
            console.log('Legal debug info:', info);
            alert('Debug information logged to console. Check browser developer tools.');
        };
        
        // Set up tab functionality
        document.querySelectorAll('.legal-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.legal-tab').forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Load the selected document
                const filename = tab.getAttribute('data-doc');
                currentDoc = filename;
                loadDocument(filename);
            });
        });
        
        // Handle both immediate loading and backend ready event
        function initializeLegal() {
            console.log('Initializing legal page...');
            loadDocument(currentDoc);
        }
        
        // Listen for backend ready event (from Electron)
        window.addEventListener('backendReady', (event) => {
            console.log('Backend ready event received for legal page:', event.detail);
            initializeLegal();
        });
        
        // Also try to load immediately if backend URL is already available
        if (window.BACKEND_URL || document.readyState === 'complete') {
            console.log('Backend URL already available or DOM ready, loading legal immediately');
            initializeLegal();
        } else if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM content loaded for legal page, checking for backend...');
                // Give a short delay for Electron to set the backend URL
                setTimeout(initializeLegal, 100);
            });
        } else {
            // Fallback - try to load after a short delay
            setTimeout(initializeLegal, 500);
        }
    })();
</script>
