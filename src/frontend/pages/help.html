<div class="page-header">
    <h1>Guide d'Utilisation</h1>
    <p>Tout ce dont vous avez besoin pour utiliser ECT Technis efficacement</p>
</div>

<div id="help-content" class="doc-container">
    <div class="loading-docs">
        <div class="loading-spinner"></div>
        <p>Chargement de la documentation...</p>
    </div>
</div>

<script>
    (function() {
        const helpContent = document.getElementById('help-content');
        
        // Function to get the backend URL (set by Electron or default for web)
        function getBackendUrl() {
            return window.BACKEND_URL || 'http://localhost:5000';
        }
        
        // Enhanced markdown to HTML conversion
        function enhancedMarkdownToHtml(markdown) {
            // Process the table of contents first
            let toc = '<div class="toc-container"><h2>Table des Matières</h2><ul class="toc-list">';
            let tocItems = [];
            
            // Extract headings for TOC
            const headingRegex = /^(#{1,3})\s+(.+)$/gm;
            let match;
            while ((match = headingRegex.exec(markdown)) !== null) {
                const level = match[1].length;
                const text = match[2].trim();
                const id = text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                
                tocItems.push({
                    level: level,
                    text: text,
                    id: id
                });
            }
            
            // Build TOC HTML (only if there are multiple headings)
            if (tocItems.length > 1) {
                tocItems.forEach(item => {
                    toc += `<li class="toc-item toc-level-${item.level}"><a href="#${item.id}" class="toc-link">${item.text}</a></li>`;
                });
                toc += '</ul></div>';
            } else {
                toc = ''; // No TOC for single section documents
            }
            
            // Replace Markdown syntax with HTML
            let html = markdown
                // Headers with IDs
                .replace(/^# (.+)$/gm, (match, title) => {
                    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h1 id="${id}" class="help-heading help-h1">${title}</h1>`;
                })
                .replace(/^## (.+)$/gm, (match, title) => {
                    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h2 id="${id}" class="help-heading help-h2">${title}</h2>`;
                })
                .replace(/^### (.+)$/gm, (match, title) => {
                    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h3 id="${id}" class="help-heading help-h3">${title}</h3>`;
                })
                .replace(/^#### (.+)$/gm, (match, title) => {
                    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h4 id="${id}" class="help-heading help-h4">${title}</h4>`;
                })
                
                // Lists
                .replace(/^\s*(?:[0-9]+\.|\-|\*)\s+(.+)$/gm, function(match, item) {
                    const isNumbered = match.trim().match(/^[0-9]+\./);
                    return `<li class="help-list-item">${item}</li>`;
                })
                
                // Bold and Italic
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                
                // Links
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                    if (url.startsWith('#')) {
                        return `<a href="${url}" class="help-link toc-link">${text}</a>`;
                    } else {
                        return `<a href="${url}" class="help-link" target="_blank" rel="noopener noreferrer">${text}</a>`;
                    }
                })
                
                // Code blocks (inline code)
                .replace(/`([^`]+)`/g, '<code class="help-code">$1</code>')
                
                // Code blocks (multi-line)
                .replace(/```([^```]+)```/g, '<pre class="help-code-block"><code>$1</code></pre>');

            // Convert newlines to paragraphs
            const paragraphs = html.split(/\n\n+/);
            html = paragraphs.map(p => {
                p = p.trim();
                
                // Skip if already wrapped in HTML tag
                if (p.startsWith('<h') || p.startsWith('<li') || p.startsWith('<pre') || p === '') return p;
                
                // Wrap content in paragraph tags if it contains text
                if (p.match(/\S/)) return `<p class="help-paragraph">${p}</p>`;
                
                return p;
            }).join('');
            
            // Fix lists - wrap consecutive li elements
            html = html.replace(/(<li class="help-list-item">.*?<\/li>)\s*(<li class="help-list-item">)/gs, '$1\n<li class="help-list-item">');
            
            // Wrap series of li in ul or ol
            const listItemRegex = /<li class="help-list-item">.*?<\/li>/gs;
            let lastIndex = 0;
            let result = '';
            let listItems;
            
            while ((listItems = listItemRegex.exec(html)) !== null) {
                result += html.substring(lastIndex, listItems.index);
                
                const isNumbered = html.substring(Math.max(0, listItems.index - 20), listItems.index).match(/[0-9]+\./);
                const listTag = isNumbered ? 'ol' : 'ul';
                
                let listContent = listItems[0];
                let nextItemMatch;
                let nextIndex = listItems.index + listItems[0].length;
                
                while ((nextItemMatch = /<li class="help-list-item">.*?<\/li>/s.exec(html.substring(nextIndex))) !== null && 
                      html.substring(nextIndex, nextIndex + nextItemMatch.index).trim() === '') {
                    listContent += nextItemMatch[0];
                    nextIndex += nextItemMatch.index + nextItemMatch[0].length;
                }
                
                result += `<${listTag} class="help-list">${listContent}</${listTag}>`;
                lastIndex = nextIndex;
                listItemRegex.lastIndex = nextIndex;
            }
            
            result += html.substring(lastIndex);
            
            return toc + '<div class="help-content">' + result + '</div>';
        }
        
        // Function to wait for backend to be ready (with timeout)
        async function waitForBackend() {
            const backendUrl = getBackendUrl();
            let retries = 0;
            const maxRetries = 20;
            
            while (retries < maxRetries) {
                try {
                    const response = await fetch(`${backendUrl}/health`, { 
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        console.log('Backend is ready');
                        return true;
                    }
                } catch (error) {
                    console.log(`Waiting for backend... (attempt ${retries + 1})`);
                }
                
                retries++;
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            throw new Error('Backend not available after multiple attempts');
        }
        
        // Function to debug available docs
        async function debugAvailableDocs() {
            try {
                const backendUrl = getBackendUrl();
                const response = await fetch(`${backendUrl}/api/docs/list`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Available documentation files:', data);
                    return data;
                } else {
                    console.error('Failed to get docs list:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error getting docs list:', error);
                return null;
            }
        }
        
        // Main function to load user guide
        async function loadUserGuide() {
            try {
                // Wait for backend to be ready
                await waitForBackend();
                
                const backendUrl = getBackendUrl();
                console.log('Loading user guide from:', `${backendUrl}/docs/user_guide.md`);
                
                // Add a small delay to ensure backend is fully ready
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const response = await fetch(`${backendUrl}/docs/user_guide.md`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/plain',
                        'Content-Type': 'text/plain; charset=utf-8'
                    }
                });
                
                if (!response.ok) {
                    console.log('Direct fetch failed, trying to debug available docs...');
                    await debugAvailableDocs();
                    throw new Error(`Failed to load help content: ${response.status} ${response.statusText}`);
                }
                
                const markdown = await response.text();
                
                if (!markdown || markdown.trim().length === 0) {
                    throw new Error('Loaded markdown content is empty');
                }
                
                console.log('Successfully loaded markdown content, length:', markdown.length);
                
                // Format the markdown into beautiful HTML
                const formattedContent = enhancedMarkdownToHtml(markdown);
                
                helpContent.innerHTML = `
                    <div class="help-card">
                        <div class="card-body help-body">
                            ${formattedContent}
                        </div>
                    </div>
                `;
                
                // Remove target="_blank" from internal links
                helpContent.querySelectorAll('a.help-link').forEach(a => {
                    if (a.getAttribute('href')?.startsWith('#')) {
                        a.removeAttribute('target');
                    }
                });
                
                // Add smooth scrolling for TOC links
                document.querySelectorAll('.toc-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = e.target.getAttribute('href').substring(1);
                        const targetElement = document.getElementById(targetId);
                        
                        if (targetElement) {
                            targetElement.scrollIntoView({ 
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    });
                });
                
                console.log('Help content loaded successfully');
                
            } catch (error) {
                console.error('Error loading help document:', error);
                
                helpContent.innerHTML = `
                    <div class="error-box">
                        <h3>Erreur de chargement</h3>
                        <p>Impossible de charger la documentation: ${error.message}</p>
                        <p><strong>Backend URL:</strong> ${getBackendUrl()}</p>
                        <button onclick="location.reload()" class="btn btn-primary" style="margin: 0.5rem;">Réessayer</button>
                        <button onclick="window.debugDocs()" class="btn btn-secondary" style="margin: 0.5rem;">Debug Info</button>
                    </div>
                `;
            }
        }
        
        // Global debug function
        window.debugDocs = async function() {
            const info = await debugAvailableDocs();
            console.log('Debug info:', info);
            alert('Debug information logged to console. Check browser developer tools.');
        };
        
        // Handle both immediate loading and backend ready event
        function initializeHelp() {
            console.log('Initializing help page...');
            loadUserGuide();
        }
        
        // Wait for window.BACKEND_URL to be available
        function waitForBackendUrl() {
            if (window.BACKEND_URL) {
                console.log('Backend URL available for help page:', window.BACKEND_URL);
                initializeHelp();
            } else {
                console.log('Waiting for backend URL...');
                setTimeout(waitForBackendUrl, 100);
            }
        }
        
        // Listen for backend ready event (from Electron)
        window.addEventListener('backendReady', (event) => {
            console.log('Backend ready event received for help page:', event.detail);
            initializeHelp();
        });
        
        // Start waiting for backend URL
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForBackendUrl);
        } else {
            waitForBackendUrl();
        }
    })();
</script>
